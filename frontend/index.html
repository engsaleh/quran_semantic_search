<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>الباحث الدلالي في القرآن الكريم</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --green-dark: #054239;
      --green-mid: #428177;
      --gold-light: #edebe0;
      --gold-mid: #b9a779;
      --gold-dark: #988561;
      --ink: #002623;
      --panel: #ffffff;
    }

    * { box-sizing: border-box; }
    body {
      font-family: "Cairo", sans-serif;
      background: var(--gold-light);
      color: var(--ink);
      margin: 0;
      line-height: 1.8;
    }

    header {
      background: var(--green-dark);
      color: var(--gold-light);
      padding: 16px;
      text-align: center;
    }

    h1 { margin: 0; font-size: 22px; font-weight: 600; }

    main {
      max-width: 900px;
      margin: auto;
      padding: 24px 16px;
    }

    #search-panel {
      background: var(--panel);
      border: 1px solid var(--gold-mid);
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    #query {
      width: 100%;
      padding: 14px;
      border: 1px solid var(--gold-mid);
      border-radius: 8px;
      margin-bottom: 14px;
      font-size: 17px;
      background: var(--gold-light);
    }

    #options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 14px;
      font-size: 15px;
    }

    #buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      font-family: inherit;
    }

    #search_btn {
      background: var(--green-mid);
      color: white;
    }
    #search_btn:hover { background: var(--gold-dark); }

    #ping_btn {
      background: var(--gold-mid);
      color: var(--ink);
    }
    #ping_btn:hover { background: var(--green-dark); color: var(--gold-light); }

    .note {
      display: block;
      margin-top: 8px;
      color: var(--gold-dark);
      font-size: 14px;
    }

    /* اللوحة التوضيحية */
    .legend {
      margin-top: 20px;
      background: var(--gold-light);
      border: 1px dashed var(--gold-mid);
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      color: var(--ink);
      line-height: 1.6;
    }

    .legend b { color: var(--green-dark); }

    #results { margin-top: 28px; }

    .card {
      background: var(--panel);
      border: 1px solid var(--gold-mid);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 14px;
      transition: transform 0.15s, border-color 0.15s;
    }

    .card:hover { transform: scale(1.01); border-color: var(--green-mid); }

    .meta { color: var(--green-mid); font-size: 15px; margin-bottom: 6px; }
    .ayah { font-size: 17px; font-weight: 500; line-height: 1.9; }

    .context {
      background: var(--gold-light);
      border-top: 1px dashed var(--gold-mid);
      margin-top: 8px;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 15px;
    }

    @media (max-width: 640px) {
      main { padding: 16px; }
      #search-panel { padding: 14px; }
    }
  </style>
</head>

<body>
  <header><h1>الباحث الدلالي في القرآن الكريم</h1></header>

  <main>
    <section id="search-panel">
      <input id="query" type="text" placeholder="اكتب فكرة أو سؤالًا (مثال: آيات عن الصبر عند الشدة)" />

      <div id="options">
        <label><input type="checkbox" id="add_context" /> عرض سياق الآية</label>
        <label><input type="checkbox" id="sem_only" /> وضع الدلالة فقط</label>
        <select id="surah_filter"><option value="">كل السور</option></select>
      </div>

      <div id="buttons">
        <button id="search_btn">ابحث</button>
        <button id="ping_btn">فحص الاتصال</button>
      </div>

      <small class="note">قد يتأخر التشغيل الأول قليلًا لبناء الفهرس.</small>

      <!--  اللوحة التوضيحية -->
      <div class="legend">
        <b>توضيح :</b><br>
        <b>cos</b> = درجة التشابه الدلالي بين الاستعلام والآية (كلما اقتربت من 1 زاد التطابق في المعنى).<br>
        <b>bm25</b> = درجة التشابه اللفظي بين الكلمات (كلما زادت القيمة كان التطابق النصي أكبر).<br>
      </div>

      <section id="results"></section>
    </section>
  </main>

  <script>
    //  تحديد عنوان الخادم ديناميكيًا حسب بيئة التشغيل
    let API_BASE;
    if (["localhost", "127.0.0.1"].includes(window.location.hostname)) {
      API_BASE = "http://127.0.0.1:8000";
    } else if (window.location.origin && window.location.origin.startsWith("http")) {
      API_BASE = window.location.origin.replace(/\/$/, "") + "/api";
    } else {
      API_BASE = "http://127.0.0.1:8000";
    }

    console.log(" API_BASE =", API_BASE);

    async function ping() {
      try {
        const res = await fetch(`${API_BASE}/health`);
        const data = await res.json();
        alert(`تم الاتصال بالخادم\nالنموذج: ${data.model}\nالآيات: ${data.items}`);
      } catch {
        alert("تعذّر الاتصال بالخادم. شغّل backend/main.py");
      }
    }

    async function populateSurahs() {
      const sel = document.getElementById("surah_filter");
      try {
        const res = await fetch(`${API_BASE}/surahs`);
        const data = await res.json();
        (data.surahs || []).forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = `${s.id}. ${s.name}`;
          sel.appendChild(opt);
        });
      } catch (e) {
        console.error("تعذّر تحميل قائمة السور:", e);
      }
    }

    async function searchQuran() {
      const query = document.getElementById("query").value.trim();
      const add_context = document.getElementById("add_context").checked;
      const sem_only = document.getElementById("sem_only").checked;
      const surah_filter = document.getElementById("surah_filter").value;

      const searchBtn = document.getElementById("search_btn");
      const results = document.getElementById("results");

      results.innerHTML = "";
      searchBtn.disabled = true;
      searchBtn.textContent = "جارٍ البحث...";

      const payload = {
        query,
        k: 12,
        add_context,
        semantic_only: sem_only,
        surah_filter: surah_filter ? [parseInt(surah_filter)] : [],
      };

      try {
        const res = await fetch(`${API_BASE}/search`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        const rows = data.results || [];
        renderResults(rows);
      } catch (err) {
        alert("تعذّر الاتصال بالخادم.");
        console.error(err);
      } finally {
        searchBtn.disabled = false;
        searchBtn.textContent = "ابحث";
      }
    }

    function renderResults(results) {
      const c = document.getElementById("results");
      c.innerHTML = "";
      if (!results.length) {
        c.innerHTML = "<p>لا توجد نتائج.</p>";
        return;
      }

      results.forEach(r => {
        const card = document.createElement("div");
        card.className = "card";
        const s = r.scores || {};
        card.innerHTML = `
          <div class="meta">${r.surah} — آية ${r.verse_number}</div>
          <div class="ayah">${r.ayah}</div>
          ${r.context ? `
            <div class="context">
              <strong>السياق</strong><br>
              ${r.context.prev ? `<em>قبل:</em> ${r.context.prev}<br>` : ""}
              ${r.context.next ? `<em>بعد:</em> ${r.context.next}` : ""}
            </div>` : ""}
          <div class="scores">
            <small>cos=${s.cos ?? "-"}, bm25=${s.bm25 ?? "-"}</small>
          </div>`;
        c.appendChild(card);
      });
    }

    document.getElementById("search_btn").addEventListener("click", searchQuran);
    document.getElementById("ping_btn").addEventListener("click", ping);
    document.getElementById("query").addEventListener("keydown", e => { if (e.key === "Enter") searchQuran(); });
    populateSurahs();
  </script>
</body>
</html>
